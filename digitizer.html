<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="description" content="Professional graph digitizer tool for extracting data from chart images">
  <meta name="keywords" content="graph digitizer, data extraction, chart analysis, plot digitizer">
  <meta name="author" content="Graph Digitizer Pro">
  <meta name="theme-color" content="#2563eb">
  
  <title>Graph Digitizer Pro - Extract Data from Charts</title>
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%232563eb'/%3E%3Cpath d='M20 80 L40 60 L60 40 L80 20' stroke='white' stroke-width='4' fill='none'/%3E%3Ccircle cx='20' cy='80' r='5' fill='white'/%3E%3Ccircle cx='40' cy='60' r='5' fill='white'/%3E%3Ccircle cx='60' cy='40' r='5' fill='white'/%3E%3Ccircle cx='80' cy='20' r='5' fill='white'/%3E%3C/svg%3E">
  
  <!-- Preload critical resources -->
  <link rel="preload" href="digitizer-improved.css" as="style">
  <link rel="preload" href="digitizer-improved.js" as="script">
  
  <!-- Stylesheet -->
  <link rel="stylesheet" href="digitizer-improved.css">
  
  <!-- External libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js" 
          integrity="sha512-r22gChDnGvBylk90+2e/ycr3RVrDi8DIOkIGNhJlKfG2za+/KqnWZH38Cw7OqfQWGe0tg7n7HQ9YO+fN5sR+aQ==" 
          crossorigin="anonymous" 
          referrerpolicy="no-referrer"></script>
</head>
<body>
  <!-- Main Container -->
  <div id="container">
    
    <!-- Canvas Area -->
    <div id="canvas-container" role="main" aria-label="Graph Canvas Area">
      <canvas id="canvas" 
              role="img" 
              aria-label="Graph image canvas"
              tabindex="0"></canvas>
      
      <!-- Magnifier -->
      <canvas id="magnifier" 
              width="150" 
              height="150" 
              role="presentation"
              aria-hidden="true"></canvas>
      
      <!-- Status Bar -->
      <div id="status-bar" 
           role="status" 
           aria-live="polite" 
           aria-atomic="true">
        Ready to load image
      </div>
      
      <!-- Zoom Controls Overlay -->
      <div id="canvas-controls" class="canvas-overlay">
        <div class="control-group">
          <button id="zoom-in-quick" 
                  class="icon-button" 
                  title="Zoom In (+)" 
                  aria-label="Zoom in">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 5v10M5 10h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button id="zoom-out-quick" 
                  class="icon-button" 
                  title="Zoom Out (-)" 
                  aria-label="Zoom out">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M5 10h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </button>
          <button id="reset-view-quick" 
                  class="icon-button" 
                  title="Reset View (0)" 
                  aria-label="Reset view">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10 3a7 7 0 100 14 7 7 0 000-14zm0 0V1m0 16v2M1 10h2m14 0h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Controls Panel -->
    <aside id="controls" 
           role="complementary" 
           aria-label="Controls Panel">
      
      <!-- Header -->
      <header class="controls-header">
        <h1>Graph Digitizer Pro</h1>
        <p class="subtitle">Extract data from chart images</p>
      </header>
      
      <!-- Image Upload Section -->
      <section class="section">
        <label for="image-upload" class="upload-label">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M17 8l-5-5-5 5M12 3v12"/>
          </svg>
          <span>Upload Graph Image</span>
        </label>
        <input type="file" 
               id="image-upload" 
               accept="image/*" 
               aria-label="Upload graph image"
               class="visually-hidden">
      </section>
      
      <!-- View Controls -->
      <details class="control-section" open>
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1112 0A6 6 0 012 8z"/>
          </svg>
          View Controls
        </summary>
        <div class="control-content">
          <div class="button-group">
            <button id="zoom-in" title="Zoom In (+)" aria-label="Zoom in">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Zoom In
            </button>
            <button id="zoom-out" title="Zoom Out (-)" aria-label="Zoom out">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Zoom Out
            </button>
          </div>
          <button id="reset-view" title="Reset View (0)" aria-label="Reset view">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 2a6 6 0 100 12 6 6 0 000-12z" stroke="currentColor" stroke-width="1.5" fill="none"/>
            </svg>
            Reset View
          </button>
          <button id="pan-mode" title="Toggle Pan Mode" aria-label="Toggle pan mode">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
            Toggle Pan Mode
          </button>
          <button id="toggle-theme" title="Toggle Dark/Light Mode" aria-label="Toggle theme">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 1a7 7 0 107 7c0-4.418-3.582-7-7-7z"/>
            </svg>
            Toggle Dark Mode
          </button>
          
          <!-- Magnifier Settings -->
          <div class="control-group mt-3">
            <label for="magnifier-zoom">Magnifier Zoom: <span id="magnifier-zoom-value">2x</span></label>
            <input type="range" 
                   id="magnifier-zoom" 
                   min="1" 
                   max="5" 
                   step="0.5" 
                   value="2"
                   aria-label="Magnifier zoom level"
                   aria-valuemin="1"
                   aria-valuemax="5"
                   aria-valuenow="2">
          </div>
        </div>
      </details>
      
      <!-- Calibration Controls -->
      <details class="control-section" open>
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M2 2h12v12H2V2zm2 2v8h8V4H4z"/>
          </svg>
          Calibration
        </summary>
        <div class="control-content">
          <div id="axis-instruction" class="instruction-box" role="status" aria-live="polite">
            Click "Set Axis Points" to begin calibration
          </div>
          
          <div class="button-group">
            <button id="set-axes" 
                    class="primary" 
                    title="Start axis calibration"
                    aria-label="Start axis calibration">
              Set Axis Points
            </button>
            <button id="reset-axis-points" 
                    title="Reset axis points"
                    aria-label="Reset axis points">
              Reset Points
            </button>
          </div>
          
          <!-- Axis Configuration -->
          <div id="axis-inputs" class="axis-config">
            <fieldset>
              <legend class="visually-hidden">Axis Configuration</legend>
              
              <div class="checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" 
                         id="shared-origin" 
                         aria-describedby="shared-origin-desc">
                  <span>Shared Origin (X1/Y1)</span>
                </label>
                <p id="shared-origin-desc" class="help-text">Use same point for X1 and Y1</p>
                
                <label class="checkbox-label">
                  <input type="checkbox" 
                         id="orthogonal-axes"
                         aria-describedby="orthogonal-axes-desc">
                  <span>Orthogonal Axes</span>
                </label>
                <p id="orthogonal-axes-desc" class="help-text">Force perpendicular axes</p>
              </div>
              
              <div class="input-group">
                <label for="x1-value">X1 Value:</label>
                <input type="number" 
                       id="x1-value" 
                       step="any" 
                       placeholder="Enter X1"
                       aria-label="X1 axis value">
              </div>
              
              <div class="input-group">
                <label for="x2-value">X2 Value:</label>
                <input type="number" 
                       id="x2-value" 
                       step="any" 
                       placeholder="Enter X2"
                       aria-label="X2 axis value">
              </div>
              
              <div class="input-group">
                <label for="y1-value">Y1 Value:</label>
                <input type="number" 
                       id="y1-value" 
                       step="any" 
                       placeholder="Enter Y1"
                       aria-label="Y1 axis value">
              </div>
              
              <div class="input-group">
                <label for="y2-value">Y2 Value:</label>
                <input type="number" 
                       id="y2-value" 
                       step="any" 
                       placeholder="Enter Y2"
                       aria-label="Y2 axis value">
              </div>
              
              <button id="calibrate" 
                      class="primary" 
                      title="Apply calibration"
                      aria-label="Apply calibration">
                Calibrate Axes
              </button>
            </fieldset>
          </div>
          
          <!-- Axis Options -->
          <div class="button-group mt-3">
            <button id="toggle-grid" 
                    title="Show/Hide Grid"
                    aria-label="Toggle grid"
                    aria-pressed="false">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M1 1v14h14M1 5h14M1 9h14M1 13h14M5 1v14M9 1v14M13 1v14" stroke="currentColor" stroke-width="1" fill="none"/>
              </svg>
              Grid
            </button>
            <button id="toggle-log-x" 
                    title="Toggle X-axis log scale"
                    aria-label="Toggle X logarithmic scale"
                    aria-pressed="false">
              Log X
            </button>
            <button id="toggle-log-y" 
                    title="Toggle Y-axis log scale"
                    aria-label="Toggle Y logarithmic scale"
                    aria-pressed="false">
              Log Y
            </button>
          </div>
        </div>
      </details>
      
      <!-- Point Actions -->
      <details class="control-section" open>
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <circle cx="8" cy="8" r="3"/>
          </svg>
          Point Actions
        </summary>
        <div class="control-content">
          <div class="button-group">
            <button id="add-point" 
                    title="Click to add points (A)"
                    aria-label="Add point mode"
                    aria-pressed="false">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                <circle cx="8" cy="8" r="2" fill="currentColor"/>
              </svg>
              Add Point
            </button>
            <button id="adjust-point" 
                    title="Click and drag to reposition (M)"
                    aria-label="Adjust point mode"
                    aria-pressed="false">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 2v12M2 8h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
              </svg>
              Adjust
            </button>
            <button id="delete-point" 
                    class="danger"
                    title="Click to delete a point (D)"
                    aria-label="Delete point mode"
                    aria-pressed="false">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M3 3l10 10M13 3L3 13" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Delete
            </button>
          </div>
          
          <!-- Highlight Line Tool -->
          <button id="highlight-line" 
                  class="holographic mt-2" 
                  title="Hold and drag to trace a curve (H)"
                  aria-label="Highlight line mode"
                  aria-pressed="false">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display:inline-block;vertical-align:middle;margin-right:4px;">
              <path d="M2 14 L6 10 L10 6 L14 2" stroke="currentColor" stroke-width="2" fill="none"/>
            </svg>
            Highlight Line (Trace Curve)
          </button>
          
          <!-- Highlight Controls -->
          <div id="highlight-controls" class="highlight-config">
            <div class="input-group">
              <label for="highlight-line-name">Line Name:</label>
              <input type="text" 
                     id="highlight-line-name" 
                     placeholder="My Curve"
                     aria-label="Name for highlighted line">
            </div>
            
            <div class="input-group">
              <label for="n-points">Number of Points:</label>
              <input type="number" 
                     id="n-points" 
                     value="50" 
                     min="5" 
                     max="1000"
                     aria-label="Number of points to interpolate"
                     aria-valuemin="5"
                     aria-valuemax="1000"
                     aria-valuenow="50">
            </div>
            
            <div class="input-group">
              <label for="highlight-width">Brush Width: <span id="highlight-width-value">2</span>px</label>
              <input type="range" 
                     id="highlight-width" 
                     min="1" 
                     max="10" 
                     value="2"
                     aria-label="Highlight brush width"
                     aria-valuemin="1"
                     aria-valuemax="10"
                     aria-valuenow="2">
            </div>
            
            <button id="delete-highlight" 
                    class="danger"
                    title="Delete highlighted path"
                    aria-label="Delete highlight">
              Clear Highlight Path
            </button>
          </div>
          
          <!-- Point Management -->
          <div class="button-group mt-3">
            <button id="clear-points" 
                    class="danger"
                    title="Clear all points in current line"
                    aria-label="Clear all points">
              Clear All Points
            </button>
            <button id="sort-points" 
                    title="Sort points by X coordinate"
                    aria-label="Sort points by X"
                    aria-pressed="false">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M3 4h10M3 8h7M3 12h4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              Sort by X
            </button>
          </div>
        </div>
      </details>
      
      <!-- Line Management -->
      <details class="control-section" open>
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M2 14 L6 10 L10 6 L14 2" stroke="currentColor" stroke-width="2" fill="none"/>
          </svg>
          Line Management
        </summary>
        <div class="control-content">
          <div class="button-group">
            <button id="new-line" 
                    class="primary"
                    title="Create new line"
                    aria-label="Create new line">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              New Line
            </button>
            <button id="rename-line" 
                    title="Rename current line"
                    aria-label="Rename current line">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M12 3l1 1-8 8H3v-2l8-8z"/>
              </svg>
              Rename
            </button>
          </div>
          
          <div class="input-group">
            <label for="line-select">Active Line:</label>
            <select id="line-select" 
                    aria-label="Select active line">
              <option>Line 1</option>
            </select>
          </div>
        </div>
      </details>
      
      <!-- Data Import/Export -->
      <details class="control-section">
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M3 2h10v12H3V2zm2 2v8h6V4H5z"/>
          </svg>
          Data Management
        </summary>
        <div class="control-content">
          <input type="file" 
                 id="import-json-input" 
                 accept=".json" 
                 class="visually-hidden"
                 aria-label="Import JSON file">
          
          <h4 class="subsection-title">Import</h4>
          <button id="import-json" 
                  title="Import JSON data"
                  aria-label="Import JSON data">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 2v8m-3-3l3 3 3-3M3 12h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Import JSON
          </button>
          
          <h4 class="subsection-title">Export</h4>
          <button id="export-json" 
                  title="Export as JSON"
                  aria-label="Export as JSON">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 10V2m-3 3l3-3 3 3M3 12h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
            </svg>
            Export JSON
          </button>
          <button id="export-csv" 
                  title="Export as CSV"
                  aria-label="Export as CSV">
            Export CSV
          </button>
          <button id="export-xlsx" 
                  title="Export as Excel"
                  aria-label="Export as Excel">
            Export XLSX
          </button>
          <button id="export-image" 
                  title="Export canvas as image"
                  aria-label="Export canvas image">
            Export Image
          </button>
          
          <h4 class="subsection-title">Session</h4>
          <div class="button-group">
            <button id="clear-session" 
                    class="danger"
                    title="Clear saved session"
                    aria-label="Clear session">
              Clear Session
            </button>
            <button id="total-reset" 
                    class="danger"
                    title="Reset everything"
                    aria-label="Total reset">
              Total Reset
            </button>
          </div>
        </div>
      </details>
      
      <!-- Preview Data -->
      <details class="control-section">
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M2 4h12M2 8h12M2 12h12" stroke="currentColor" stroke-width="1.5"/>
          </svg>
          Data Preview
        </summary>
        <div class="control-content">
          <div class="table-container">
            <table id="preview-table" role="table" aria-label="Data preview table">
              <tbody>
                <tr>
                  <td colspan="3" class="text-center text-muted">No data yet</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </details>
      
      <!-- History Controls -->
      <details class="control-section" open>
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <path d="M8 3v5l3 3M8 14A6 6 0 108 2" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
          History
        </summary>
        <div class="control-content">
          <div class="button-group">
            <button id="undo" 
                    title="Undo (Ctrl+Z)"
                    aria-label="Undo last action"
                    disabled>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3H3v5M3 3l5 5" stroke="currentColor" stroke-width="1.5" fill="none"/>
              </svg>
              Undo
            </button>
            <button id="redo" 
                    title="Redo (Ctrl+Y)"
                    aria-label="Redo last action"
                    disabled>
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 3h5v5M13 3l-5 5" stroke="currentColor" stroke-width="1.5" fill="none"/>
              </svg>
              Redo
            </button>
          </div>
          <p class="text-muted text-center" style="font-size:12px;margin-top:8px;">
            <kbd>Ctrl+Z</kbd> / <kbd>Ctrl+Y</kbd>
          </p>
        </div>
      </details>
      
      <!-- Keyboard Shortcuts -->
      <details class="control-section">
        <summary>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="summary-icon">
            <rect x="2" y="4" width="12" height="8" rx="1" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <path d="M5 7h6M5 9h4"/>
          </svg>
          Keyboard Shortcuts
        </summary>
        <div class="control-content">
          <div class="shortcuts-list">
            <div class="shortcut-item">
              <kbd>+</kbd>
              <span>Zoom In</span>
            </div>
            <div class="shortcut-item">
              <kbd>-</kbd>
              <span>Zoom Out</span>
            </div>
            <div class="shortcut-item">
              <kbd>0</kbd>
              <span>Reset View</span>
            </div>
            <div class="shortcut-item">
              <kbd>A</kbd>
              <span>Add Point Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>M</kbd>
              <span>Adjust Point Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>D</kbd>
              <span>Delete Point Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>H</kbd>
              <span>Highlight Line Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>Esc</kbd>
              <span>Cancel Current Mode</span>
            </div>
            <div class="shortcut-item">
              <kbd>Ctrl+Z</kbd>
              <span>Undo</span>
            </div>
            <div class="shortcut-item">
              <kbd>Ctrl+Y</kbd>
              <span>Redo</span>
            </div>
          </div>
        </div>
      </details>
      
      <!-- Footer -->
      <footer class="controls-footer">
        <p class="text-muted" style="font-size:12px;text-align:center;">
          Graph Digitizer Pro v2.0<br>
          <a href="#" id="about-link" style="color:var(--primary-color);">About</a> | 
          <a href="#" id="help-link" style="color:var(--primary-color);">Help</a>
        </p>
      </footer>
    </aside>
  </div>
  
  <!-- Modal Dialog -->
  <div id="modal" 
       role="dialog" 
       aria-modal="true" 
       aria-labelledby="modal-title"
       class="modal">
    <div id="modal-content" class="modal-content">
      <h2 id="modal-title" class="visually-hidden">Dialog</h2>
      <!-- Content will be inserted dynamically -->
    </div>
  </div>
  
  <!-- Loading Spinner -->
  <div id="spinner" 
       role="status" 
       aria-live="polite" 
       aria-label="Loading">
    <div class="spinner-content">
      <div class="spinner-animation"></div>
      <p>Processing...</p>
    </div>
  </div>
  
  <!-- Toast Notifications -->
  <div id="toast-container" 
       role="region" 
       aria-live="polite" 
       aria-label="Notifications">
  </div>
  
  <!-- Main Script -->
  <script src="digitizer-improved.js" defer></script>
  
  <!-- Service Worker Registration (Progressive Web App) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').catch(() => {
          // Service worker registration failed, continue without it
        });
      });
    }
  </script>
</body>
</html>
